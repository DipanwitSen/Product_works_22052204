{% extends 'base.html' %} {% block title %}DB Manager Dashboard{% endblock %} {%
block content %}
<div class="min-h-screen container mx-auto p-4 md:p-8 space-y-10">
  <!-- Heading -->
  <h2
    class="text-4xl font-extrabold text-center mb-10 text-blue-700 border-b-4 border-blue-200 pb-4"
  >
    Database Manager Dashboard
  </h2>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
    <!-- Execute SQL Card -->
    <div class="dashboard-card p-6 shadow-2xl transition-all hover:shadow-3xl">
      <h3 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">
        Execute Custom SQL
      </h3>

      <form method="post" action="{{ url_for('db_dashboard') }}">
        <input type="hidden" name="action" value="execute" />
        <div class="mb-4">
          <label
            for="query"
            class="block text-lg font-medium text-gray-700 mb-2"
            >SQL Query</label
          >
          <textarea
            name="query"
            id="query"
            rows="8"
            placeholder="e.g., SELECT * FROM users WHERE role='seller'"
            required
            class="w-full p-4 border border-gray-300 rounded-xl shadow-inner focus:ring-blue-500 focus:border-blue-500 text-sm"
          >
{{ query if query else '' }}</textarea
          >
        </div>

        {% if error %}
        <div
          class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4"
          role="alert"
        >
          <strong class="font-bold">SQL Error:</strong>
          <span class="block sm:inline">{{ error }}</span>
        </div>
        {% endif %}

        <button
          type="submit"
          class="btn-primary w-full py-3 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
        >
          <i class="fa fa-terminal mr-2"></i> Execute Query
        </button>
      </form>

      {% if results %}
      <div class="mt-8">
        <h4 class="text-xl font-semibold mb-3 text-gray-800">Results</h4>
        {% if results is string %}
        <div
          class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl"
          role="alert"
        >
          <strong class="font-bold">Success:</strong>
          <span class="block sm:inline">{{ results }}</span>
        </div>
        {% elif results %}
        <div class="overflow-x-auto bg-white p-4 rounded-xl shadow-inner">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                {% for key in results[0].keys() %}
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  {{ key }}
                </th>
                {% endfor %}
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for row in results %}
              <tr>
                {% for value in row.values() %}
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                  {{ value }}
                </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-gray-500">Query returned no rows.</p>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Create Table Card -->
    <div class="dashboard-card p-6 shadow-2xl transition-all hover:shadow-3xl">
      <h3 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-2">
        Create New Table
      </h3>
      <form method="post" action="{{ url_for('db_dashboard') }}">
        <input type="hidden" name="action" value="create_table" />
        <div class="mb-4">
          <label
            for="table_name"
            class="block text-lg font-medium text-gray-700 mb-2"
            >Table Name</label
          >
          <input
            type="text"
            name="table_name"
            id="table_name"
            placeholder="e.g., inventory_logs"
            required
            class="w-full p-4 border border-gray-300 rounded-xl shadow-inner focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <h4 class="text-xl font-semibold mb-3 text-gray-800">Columns</h4>
        <div id="columns-container" class="space-y-4 mb-6">
          <!-- Initial Column -->
          <div class="flex flex-col md:flex-row gap-4 items-center">
            <input
              type="text"
              name="column_name[]"
              placeholder="Column Name (e.g., id)"
              required
              class="flex-1 w-full p-4 border border-gray-300 rounded-xl shadow-inner"
            />
            <select
              name="column_type[]"
              class="p-4 border border-gray-300 rounded-xl shadow-inner"
            >
              <option value="TEXT">TEXT</option>
              <option value="INTEGER">INTEGER</option>
              <option value="REAL">REAL</option>
              <option value="BLOB">BLOB</option>
            </select>
            <input
              type="text"
              name="column_constraints[]"
              placeholder="Constraints (e.g., PRIMARY KEY, NOT NULL)"
              class="flex-1 w-full p-4 border border-gray-300 rounded-xl shadow-inner"
            />
            <button
              type="button"
              onclick="removeColumn(this)"
              class="p-4 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors duration-200 shadow-md flex-shrink-0"
            >
              <i class="fa fa-trash-alt"></i>
            </button>
          </div>
        </div>

        <button
          type="button"
          onclick="addColumn()"
          class="w-full bg-yellow-500 text-white font-semibold py-3 rounded-xl shadow-lg hover:bg-yellow-600 transition-colors duration-300 mb-6"
        >
          <i class="fa fa-plus-circle mr-2"></i> Add Column
        </button>

        <button
          type="submit"
          class="btn-primary w-full py-3 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300"
        >
          <i class="fa fa-table mr-2"></i> Create Table
        </button>
      </form>
    </div>
  </div>

  <!-- Manage Orders Card -->
  <div class="dashboard-card p-8 shadow-2xl">
    <h3 class="text-3xl font-bold text-teal-600 mb-6">Manage Orders</h3>
    <div class="overflow-x-auto rounded-xl shadow-md">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-teal-50">
          <tr>
            <th class="px-6 py-3 text-left font-medium text-gray-700">ID</th>
            <th class="px-6 py-3 text-left font-medium text-gray-700">User</th>
            <th class="px-6 py-3 text-left font-medium text-gray-700">
              Shipping Info
            </th>
            <th class="px-6 py-3 text-left font-medium text-gray-700">
              Status
            </th>
            <th class="px-6 py-3 text-left font-medium text-gray-700">
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for order in orders %}
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">{{ order.id }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ order.user_name }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ order.shipping }}</td>
            <td class="px-6 py-4 whitespace-nowrap">{{ order.status }}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <!-- Update / Delete buttons -->
              <form method="post" class="flex gap-2">
                <input type="hidden" name="order_id" value="{{ order.id }}" />
                <button
                  name="action"
                  value="update_status"
                  class="px-4 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600"
                >
                  Update
                </button>
                <button
                  name="action"
                  value="delete_order"
                  class="px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600"
                >
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  function addColumn() {
    const container = document.getElementById("columns-container");
    const newRow = document.createElement("div");
    newRow.className = "flex flex-col md:flex-row gap-4 items-center";
    newRow.innerHTML = `
            <input type="text" name="column_name[]" placeholder="Column Name" required class="flex-1 w-full p-4 border border-gray-300 rounded-xl shadow-inner"/>
            <select name="column_type[]" class="p-4 border border-gray-300 rounded-xl shadow-inner">
                <option value="TEXT">TEXT</option>
                <option value="INTEGER">INTEGER</option>
                <option value="REAL">REAL</option>
                <option value="BLOB">BLOB</option>
            </select>
            <input type="text" name="column_constraints[]" placeholder="Constraints (e.g., PRIMARY KEY, NOT NULL)" class="flex-1 w-full p-4 border border-gray-300 rounded-xl shadow-inner"/>
            <button type="button" onclick="removeColumn(this)" class="p-4 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors duration-200 shadow-md flex-shrink-0">
                <i class="fa fa-trash-alt"></i>
            </button>
        `;
    container.appendChild(newRow);
    toggleRemoveButtons();
  }

  function removeColumn(button) {
    button.closest(".flex-col, .flex-row").remove();
    toggleRemoveButtons();
  }

  function toggleRemoveButtons() {
    const container = document.getElementById("columns-container");
    const removeButtons = container.querySelectorAll(
      'button[onclick="removeColumn(this)"]'
    );
    removeButtons.forEach(
      (btn) =>
        (btn.style.visibility = removeButtons.length > 1 ? "visible" : "hidden")
    );
  }

  document.addEventListener("DOMContentLoaded", () => {
    toggleRemoveButtons();
  });
</script>
{% endblock %}
